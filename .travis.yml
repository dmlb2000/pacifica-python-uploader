services:
- postgresql
- mysql
- elasticsearch
- rabbitmq
addons:
  apt:
    sources:
    - elasticsearch-5.x
    packages:
    - elasticsearch
    - oracle-java8-set-default
stages:
- lint
- test
- deploy
env:
  POSTGRES_ENV_POSTGRES_USER: postgres
  POSTGRES_ENV_POSTGRES_PASSWORD:
cache: pip
before_install:
- pip install --upgrade pip setuptools wheel
- bash -xe travis/before-install.sh
install:
- pip install -r requirements-dev.txt


.test_job: &test_job
  language: python
  stage: test
  script:
  - coverage run --include='pacifica/*' -m pytest -v
  - coverage report --show-missing --fail-under 100
  - if [[ $CODECLIMATE_REPO_TOKEN ]] ; then codeclimate-test-reporter ; fi
  - pip install .
  - python setup.py bdist_wheel
  - python setup.py sdist

.lint_job: &lint_job
  language: python
  stage: lint
  script:
  - pre-commit run -a
  - radon cc pacifica

.deploy_job: &deploy_job
  language: python
  stage: deploy
  script: skip

jobs:
  include:
  - <<: *lint_job
    python: 3.6
  - <<: *lint_job
    python: 2.7
  - <<: *test_job
    python: 3.6
  - <<: *test_job
    python: 2.7
  - <<: *deploy_job
    python: 3.6
    deploy:
      skip_cleanup: true
      provider: pypi
      user: dmlb2000
      distributions: sdist bdist_wheel
      password:
        secure: paSvml0+LPQTY/oMXWpV6EIPfgLrHXJjsWqnZXyOGmWmV6kE8gDNls0iT4NEqlhcg0V7VA1274TPfA4sceSnxzR99HJDHlodyqCq86ehSsKmCHFHosi7Fgjtdh8ybbxV1TKhODVSPz414jqwZbdWdCDtEzGnqXfhsGQ4jc+yfKaGaLbjwKQF0VwyaxYXUWb9tVtmxDN0ywwPyNGHU5vSWcyFh+JblugtUBTc4bpwMcJMw6S+dWa/MKOjA/b0k0wWTbnF5u1ebKsmorThipxi3/XiFUzHsJJH/lI5OMXd6vZ6c3g5j0TS+dC6IaJA/8eoITbMw6doqdunsaGjq7xqjioVu/ROMKjlFHxmqz6uJEeLB4RJPqp/CKmAMjFnXUT0aRA0rKUT1USBhuwagQHzHEwOt9q6hH0t0ox2bpjhR7H7g4fzb2BWZ/IQGSPIcpv94DWxYex+xfPOD/18xbNp7hP1aQEc7UbKtFltcaYXUADyS7d/Llh4Hp8YSh+9ptTLsCsVdUBd9zxEYjFcGIdUZKpoeTuKasrwmX3KQIuAg6wht/H1q7OsGb9qi9FCGEiwzTxCuub9c01PcSqEJiBjosQJLYTTmcVBHsLXfYq06JQe/CqnClZXqFoJvtBoD9Q1cxVF/6HyZ1dsOWZzA8ksirQwLkvMH5Kwf0t6v3gN18I=
      on:
        tags: true
  - <<: *deploy_job
    python: 2.7
    deploy:
      skip_cleanup: true
      provider: pypi
      user: dmlb2000
      distributions: sdist bdist_wheel
      password:
        secure: paSvml0+LPQTY/oMXWpV6EIPfgLrHXJjsWqnZXyOGmWmV6kE8gDNls0iT4NEqlhcg0V7VA1274TPfA4sceSnxzR99HJDHlodyqCq86ehSsKmCHFHosi7Fgjtdh8ybbxV1TKhODVSPz414jqwZbdWdCDtEzGnqXfhsGQ4jc+yfKaGaLbjwKQF0VwyaxYXUWb9tVtmxDN0ywwPyNGHU5vSWcyFh+JblugtUBTc4bpwMcJMw6S+dWa/MKOjA/b0k0wWTbnF5u1ebKsmorThipxi3/XiFUzHsJJH/lI5OMXd6vZ6c3g5j0TS+dC6IaJA/8eoITbMw6doqdunsaGjq7xqjioVu/ROMKjlFHxmqz6uJEeLB4RJPqp/CKmAMjFnXUT0aRA0rKUT1USBhuwagQHzHEwOt9q6hH0t0ox2bpjhR7H7g4fzb2BWZ/IQGSPIcpv94DWxYex+xfPOD/18xbNp7hP1aQEc7UbKtFltcaYXUADyS7d/Llh4Hp8YSh+9ptTLsCsVdUBd9zxEYjFcGIdUZKpoeTuKasrwmX3KQIuAg6wht/H1q7OsGb9qi9FCGEiwzTxCuub9c01PcSqEJiBjosQJLYTTmcVBHsLXfYq06JQe/CqnClZXqFoJvtBoD9Q1cxVF/6HyZ1dsOWZzA8ksirQwLkvMH5Kwf0t6v3gN18I=
      on:
        tags: true
